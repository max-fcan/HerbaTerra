{% extends "base.html" %}
{% block title %}{{ species.species }} - HerbaTerra{% endblock %}

{% block page_content %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/catalogue.css') }}"
/>

<style>
  .species-summary-box {
    background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%);
    border: 1px solid #4CAF50;
    border-radius: 12px;
    padding: clamp(12px, 1.05vw, 20px);
    margin: clamp(12px, 1.05vw, 20px) 0;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);
  }

  .summary-item {
    background: rgba(0, 0, 0, 0.3);
    padding: clamp(8px, 0.63vw, 12px);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .location-filter-status {
    color: #8fd39a;
    font-size: 0.85rem;
    font-style: italic;
    opacity: 0.85;
    margin-left: clamp(6px, 0.52vw, 10px);
  }
</style>

<div class="species-detail-page">
  <!-- ── Top half: Species information ────────────────────────────── -->
  <div class="species-info-panel">
    <a href="{{ url_for('catalogue.index') }}" class="back-link"
      >← Back to Catalogue</a
    >

    <!-- Primary info -->
    <div class="species-primary">
      <h1 class="species-name">{{ species.species }}</h1>
      <div class="species-taxonomy-bar">
        <span class="tax-badge family-badge" title="Family"
          >{{ species.family }}</span
        >
        <span class="tax-badge genus-badge" title="Genus"
          >{{ species.genus }}</span
        >
        {% if species.taxon_rank %}
        <span class="tax-badge rank-badge" title="Taxonomic rank"
          >{{ species.taxon_rank }}</span
        >
        {% endif %}
      </div>
    </div>

    <!-- Quick Summary Section -->
    <div class="species-summary-box">
      <h3 style="margin: 0 0 0.8rem 0; color: #4CAF50; font-size: 1.1rem;">Quick Summary</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(min(200px, 100%), 1fr)); gap: clamp(8px, 0.79vw, 15px);">
        <div class="summary-item">
          <strong style="color: #888;">Most Common Location:</strong>
          <div style="color: #ffffff; margin-top: 4px;">{{ species.predominant_country }}</div>
        </div>
        <div class="summary-item">
          <strong style="color: #888;">Most Common Continent:</strong>
          <div style="color: #ffffff; margin-top: 4px;">{{ species.predominant_continent }}</div>
        </div>
        <div class="summary-item">
          <strong style="color: #888;">Total Observations:</strong>
          <div style="color: #ffffff; margin-top: 4px;">{{ species.observation_count }}</div>
        </div>
        <div class="summary-item">
          <strong style="color: #888;">Photo Count:</strong>
          <div style="color: #ffffff; margin-top: 4px;">{{ species.image_count }}</div>
        </div>
      </div>
    </div>

    <!-- Stats row -->
    <div class="species-stats">
      <div class="stat-card">
        <span class="stat-value">{{ species.image_count }}</span>
        <span class="stat-label">Photos</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{{ species.observation_count }}</span>
        <span class="stat-label">Observations</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{{ species.locations | length }}</span>
        <span class="stat-label">Locations</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{{ species.earliest_date }}</span>
        <span class="stat-label">First Seen</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{{ species.latest_date }}</span>
        <span class="stat-label">Last Seen</span>
      </div>
    </div>

    <!-- Locations section -->
    <div class="species-locations">
      <h2 class="section-heading">Observation Locations <span id="locationFilterStatus" class="location-filter-status"></span></h2>
      <div class="location-list">
        {% for loc, count in species.locations[:12] %}
        <div class="location-chip" data-location="{{ loc }}">
          <span class="loc-name">{{ loc }}</span>
          <span class="loc-count">{{ count }}</span>
        </div>
        {% endfor %}
        {% if species.locations | length > 12 %}
        <div
          class="location-chip more-chip"
          id="showMoreLocations"
          onclick="
            document.getElementById('hiddenLocations').style.display = 'flex';
            this.style.display = 'none';
          "
        >
          +{{ species.locations | length - 12 }} more
        </div>
        <div
          class="location-overflow"
          id="hiddenLocations"
          style="display: none"
        >
          {% for loc, count in species.locations[12:] %}
          <div class="location-chip" data-location="{{ loc }}">
            <span class="loc-name">{{ loc }}</span>
            <span class="loc-count">{{ count }}</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Additional detail -->
    <div class="species-extra">
      <div class="extra-item">
        <span class="extra-label">Predominant Region</span>
        <span class="extra-value"
          >{{ species.predominant_country }}, {{ species.predominant_continent
          }}</span
        >
      </div>
      {% if species.images[0].license %}
      <div class="extra-item">
        <span class="extra-label">License</span>
        <span class="extra-value"
          >{{ species.images[0].license |
          replace('http://creativecommons.org/licenses/', 'CC ') | replace('/',
          '') }}</span
        >
      </div>
      {% endif %}
      {% if species.images[0].occurrence_url %}
      <div class="extra-item">
        <span class="extra-label">Source</span>
        <a
          href="{{ species.images[0].occurrence_url }}"
          target="_blank"
          rel="noopener"
          class="extra-value extra-link"
          >iNaturalist ↗</a
        >
      </div>
      {% endif %}
      <div class="extra-item">
        <span class="extra-label">Learn More</span>
        <a
          href="https://www.google.com/search?q={{ species.species | urlencode }}"
          target="_blank"
          rel="noopener"
          class="extra-value extra-link"
          >Google Search ↗</a
        >
      </div>
    </div>
  </div>

  <!-- ── Photo Gallery ────────────────────────────────────────────── -->
  <div class="species-gallery-panel">
    <div class="gallery-header">
      <h2 class="gallery-heading">
        Photos <span class="gallery-count">({{ species.image_count }})</span>
      </h2>
      <div class="gallery-controls">
        <button class="view-toggle" id="viewToggle" title="Toggle view mode" aria-label="Switch between carousel and grid view">
          <svg class="icon-grid" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
          <svg class="icon-carousel" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
            <rect x="2" y="7" width="20" height="10" rx="2"></rect>
          </svg>
        </button>
      </div>
    </div>

    <!-- Carousel View -->
    <div class="gallery-carousel-view active" id="carouselView">
      <div class="gallery-slider-wrap">
        <button class="slider-arrow slider-arrow-left" id="sliderLeft" aria-label="Scroll left">
          ‹
        </button>

        <div class="gallery-slider" id="gallerySlider">
          {% for img in species.images %}
          <div class="slider-card" data-index="{{ loop.index0 }}" data-location="{{ img.location_str }}">
            <div class="slider-card-image">
              <img
                src="{{ img.image_url }}"
                alt="{{ species.species }} observation {{ loop.index }}"
                loading="lazy"
                onerror="this.closest('.slider-card').classList.add('error')"
              />
              <div class="image-overlay">
                <button class="zoom-btn" aria-label="View full size">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                    <line x1="11" y1="8" x2="11" y2="14"></line>
                    <line x1="8" y1="11" x2="14" y2="11"></line>
                  </svg>
                </button>
              </div>
            </div>
            <div class="slider-card-info">
              {% if img.city or img.country %}
              <span class="info-location">{{ img.city }}{% if img.city and img.country %}, {% endif %}{{ img.country }}</span>
              {% endif %}
              {% if img.eventDate %}
              <span class="info-date">{{ img.eventDate[:10] }}</span>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>

        <button class="slider-arrow slider-arrow-right" id="sliderRight" aria-label="Scroll right">
          ›
        </button>
      </div>
    </div>

    <!-- Grid View -->
    <div class="gallery-grid-view" id="gridView">
      <div class="gallery-grid">
        {% for img in species.images %}
        <div class="grid-item" data-index="{{ loop.index0 }}" data-location="{{ img.location_str }}">
          <div class="grid-item-image">
            <img
              src="{{ img.image_url }}"
              alt="{{ species.species }} observation {{ loop.index }}"
              loading="lazy"
              onerror="this.closest('.grid-item').classList.add('error')"
            />
            <div class="grid-overlay">
              <span class="grid-number">{{ loop.index }}</span>
              {% if img.city %}
              <span class="grid-location">{{ img.city }}</span>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- ── Lightbox ─────────────────────────────────────────────────── -->
  <div class="lightbox-overlay" id="lightbox">
    <div class="lightbox-header">
      <div class="lightbox-counter" id="lightboxCounter">1 / {{ species.image_count }}</div>
      <button class="lightbox-close" id="lightboxClose" aria-label="Close gallery">
        ✕
      </button>
    </div>

    <div class="lightbox-content">
      <button class="lightbox-nav lightbox-prev" id="lightboxPrev" aria-label="Previous image">
        ‹
      </button>

      <div class="lightbox-image-container">
        <img class="lightbox-img" id="lightboxImg" src="" alt="" />
        <div class="lightbox-loader" id="lightboxLoader">
          <div class="spinner"></div>
        </div>
      </div>

      <button class="lightbox-nav lightbox-next" id="lightboxNext" aria-label="Next image">
        ›
      </button>
    </div>

    <div class="lightbox-footer">
      <div class="lightbox-caption" id="lightboxCaption"></div>
      <div class="lightbox-thumbnails" id="lightboxThumbnails"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
  // Pass images data for lightbox and filtering
  window.__speciesImages = {{ species.images | tojson }};
  window.__allImages = {{ species.images | tojson }};

  // Location filtering
  (function() {
    let currentLocationFilter = null;
    const allImages = window.__allImages || [];
    const slider = document.getElementById('gallerySlider');
    const locationChips = document.querySelectorAll('.location-chip[data-location]');
    const filterStatus = document.getElementById('locationFilterStatus');

    // Check for location parameter in URL
    const urlParams = new URLSearchParams(window.location.search);
    const locationParam = urlParams.get('location');

    function normalizeLocation(loc) {
      return loc.toLowerCase().trim().replace(/\s+/g, ' ');
    }

    function getLocationTokens(loc) {
      return loc
        .split(',')
        .map(token => normalizeLocation(token))
        .filter(Boolean);
    }

    function matchesLocation(cardLocation, filterLocation) {
      const filterTokens = getLocationTokens(filterLocation);
      if (filterTokens.length === 0) return false;
      const cardTokens = getLocationTokens(cardLocation);
      return filterTokens.every(filterToken =>
        cardTokens.some(cardToken => cardToken.includes(filterToken) || filterToken.includes(cardToken))
      );
    }

    function filterImagesByLocation(location) {
      if (!location) return;
      currentLocationFilter = location;
      const carouselCards = slider ? slider.querySelectorAll('.slider-card') : [];
      const gridItems = document.querySelectorAll('.grid-item');
      let visibleCount = 0;

      carouselCards.forEach(card => {
        const cardLocation = card.getAttribute('data-location') || '';
        if (matchesLocation(cardLocation, location)) {
          card.style.display = 'block';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });

      gridItems.forEach(item => {
        const itemLocation = item.getAttribute('data-location') || '';
        item.style.display = matchesLocation(itemLocation, location) ? 'block' : 'none';
      });

      if (filterStatus) {
        filterStatus.textContent = `Filtered · ${visibleCount} photos — ${location}`;
      }

      locationChips.forEach(chip => {
        const chipLoc = chip.getAttribute('data-location');
        if (chipLoc && matchesLocation(chipLoc, location)) {
          chip.style.backgroundColor = 'rgba(76, 175, 80, 0.3)';
          chip.style.border = '2px solid #4CAF50';
        } else {
          chip.style.backgroundColor = '';
          chip.style.border = '';
        }
      });

      const filteredImages = allImages.filter(img => matchesLocation(img.location_str || '', location));
      window.__speciesImages = filteredImages;
      if (window.galleryState) window.galleryState.images = filteredImages;

      let newIndex = 0;
      carouselCards.forEach(card => {
        if (card.style.display !== 'none') { card.setAttribute('data-index', newIndex); newIndex++; }
      });
      gridItems.forEach(item => {
        if (item.style.display !== 'none') { item.setAttribute('data-index', newIndex); newIndex++; }
      });
    }

    function clearFilter() {
      currentLocationFilter = null;
      const carouselCards = slider ? slider.querySelectorAll('.slider-card') : [];
      carouselCards.forEach((card, index) => { card.style.display = 'block'; card.setAttribute('data-index', index); });
      const gridItems = document.querySelectorAll('.grid-item');
      gridItems.forEach((item, index) => { item.style.display = 'block'; item.setAttribute('data-index', index); });
      if (filterStatus) filterStatus.textContent = '';
      locationChips.forEach(chip => { chip.style.backgroundColor = ''; chip.style.border = ''; });
      window.__speciesImages = allImages;
      if (window.galleryState) window.galleryState.images = allImages;
    }

    locationChips.forEach(chip => {
      chip.addEventListener('click', function() {
        const location = this.getAttribute('data-location');
        if (currentLocationFilter === location) clearFilter();
        else filterImagesByLocation(location);
      });
    });

    if (locationParam) filterImagesByLocation(decodeURIComponent(locationParam));
  })();
</script>
<script src="{{ url_for('static', filename='js/catalogue.js') }}"></script>
{% endblock %}
