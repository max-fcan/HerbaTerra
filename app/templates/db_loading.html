{% extends "base.html" %}

{% block title %}Loading Database | HerbaTerra{% endblock %}
{% block body_class %}subpage{% endblock %}

{% block content %}
<section class="container py-5" style="max-width: 760px; margin-top: 7rem;">
  <article class="card shadow-sm" style="background: rgba(8, 16, 14, 0.78); color: #e8f3e4; border: 1px solid rgba(205, 240, 198, 0.24);">
    <div class="card-body p-4 p-md-5">
      <h1 class="h3 mb-3">Preparing Local Database</h1>
      <p id="dbStatusMessage" class="mb-3">{{ replica_status.message }}</p>
      <p id="dbState" class="mb-0 text-light-emphasis"></p>
      <p id="dbError" class="mt-3 mb-0 text-danger" hidden></p>
    </div>
  </article>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  (function () {
    "use strict";

    const statusMessage = document.getElementById("dbStatusMessage");
    const stateNode = document.getElementById("dbState");
    const errorNode = document.getElementById("dbError");

    function applyStatus(status) {
      if (!status || typeof status !== "object") return;

      statusMessage.textContent = status.message || "Preparing local embedded replica...";
      stateNode.textContent = `State: ${status.state || "unknown"}`;

      if (status.state === "error") {
        errorNode.hidden = false;
        errorNode.textContent = status.error || "Local embedded replica failed to initialize.";
      } else {
        errorNode.hidden = true;
        errorNode.textContent = "";
      }

      if (status.state === "ready" || status.state === "already_exists") {
        window.location.replace("{{ url_for('pages.hub') }}");
      }
    }

    async function pollStatus() {
      try {
        const response = await fetch("{{ url_for('api.replica_status_api') }}", {
          cache: "no-store",
          credentials: "same-origin",
        });
        if (!response.ok) {
          throw new Error(`Status API failed: ${response.status}`);
        }
        const status = await response.json();
        applyStatus(status);
      } catch (_error) {
        errorNode.hidden = false;
        errorNode.textContent = "Could not fetch loading status. Retrying...";
      }
    }

    applyStatus({{ replica_status | tojson }});
    pollStatus();
    window.setInterval(pollStatus, 1500);
  })();
</script>
{% endblock %}
