{% extends "base.html" %}
{% block title %}Play - HerbaTerra{% endblock %}

{% block nav %}{% endblock %}

{% block page_content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/game.css') }}" />

<div class="game-container">
    <a href="{{ url_for('game.index') }}" class="return-button">← Return</a>

    {% if challenge and challenge.url %}
        <div class="image-container" id="image-container">
            <img id="challenge-image"
                 src="{{ challenge.url }}"
                 alt="Plant observation"
                 class="challenge-image"
                 decoding="async">
            <div class="image-loading-overlay" id="image-loading-overlay" aria-hidden="true">
                <div class="spinner"></div>
            </div>
            {% if challenge.species_info %}
            <div class="image-attribution" id="image-attribution">
                {% if challenge.species_info.license %}
                    License: {{ challenge.species_info.license }}
                {% endif %}
                {% if challenge.species_info.rightsHolder %}
                    | © {{ challenge.species_info.rightsHolder }}
                {% endif %}
                {% if challenge.species_info.occurrence_url %}
                    | <a href="{{ challenge.species_info.occurrence_url }}" target="_blank" rel="noopener">Source</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="options-container">
            <div class="species-info-card" id="species-info-card">
                {% if challenge.species_info and challenge.species_info.species %}
                <h3>{{ challenge.species_info.species }}</h3>
                <div class="taxonomy">
                    <span>Family:</span> {{ challenge.species_info.family or 'Unknown' }} |
                    <span>Genus:</span> {{ challenge.species_info.genus or 'Unknown' }}
                </div>
                <a href="{{ url_for('catalogue.species_detail', species_name=challenge.species_info.species, location=challenge.solution.details) }}"
                   class="view-detail-link">View Species Details →</a>
                {% endif %}
            </div>
            <div id="options-list" style="display: flex; flex-direction: column; gap: clamp(8px, 0.79vw, 15px); width: 100%;">
                {% for option in challenge.proposed_locations %}
                <div class="option-card"
                     data-lat="{{ option.coordinates.lat }}"
                     data-lon="{{ option.coordinates.lon }}">
                    <div class="continent-label">continent: {{ option.continent }}</div>
                    {% if option.details %}
                    <div class="details-label">{{ option.details }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <div class="next-button-container">
                <button type="button" class="next-button" id="next-button">Next Challenge →</button>
            </div>
        </div>
    {% else %}
        <div style="display: flex; justify-content: center; align-items: center; height: 100%; width: 100%; flex-direction: column; color: white;">
            <h2>No challenge available right now.</h2>
            <p>Please check back later.</p>
            <a href="{{ url_for('game.index') }}" class="btn" style="color: white; border: 1px solid white; padding: clamp(6px, 0.52vw, 10px) clamp(12px, 1.05vw, 20px); border-radius: 20px; text-decoration: none; margin-top: clamp(12px, 1.05vw, 20px);">Go Back</a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block page_scripts %}
{% if challenge and challenge.url %}
<script id="challenge-data" type="application/json">{{ challenge | tojson }}</script>
<script
  src="{{ url_for('static', filename='js/game.js') }}"
  data-next-url="{{ url_for('api.next_challenge') }}"
  data-species-base="{{ url_for('catalogue.species_detail', species_name='__SPECIES__') }}"
></script>
{% endif %}
{% endblock %}
